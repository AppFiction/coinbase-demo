console.log("CoinApp Running");const express=require("express"),https=require("https"),Client=require("coinbase").Client,app=express(),sendAmt="0.000025";let client=null;app.get("/",function(a,b){b.redirect(`https://www.coinbase.com/oauth/authorize?client_id=4ae06befeedf464ecc5606a87163dc3236621360730133e690ba9c90a494ef10&redirect_uri=http%3A%2F%2F127.0.0.1%3A3000%2Fform&response_type=code&scope=wallet:accounts:read,wallet:transactions:send&meta[send_limit_amount]=1&meta[send_limit_currency]=USD&meta[send_limit_period]=day`)}),app.get("/form",function(a,b){const c=a.query,d=c.code;return getAccessToken(d).then(a=>{const c=a.access_token;client=new Client({accessToken:c,refreshToken:a.refresh_token,strictSSL:!1}),getAccount(client,b).then(a=>{accountID=a.account.id;const c=`Balance: ${a.account.balance.currency} ${a.account.balance.amount}`;b.send(mainForm({code:d,balString:c}))}).catch(a=>{console.log("Error1: ",a)})})}),app.get("/send/",function(a,b){const c=a.query,d=c.code,e=c.destID;getAccount(client,b).then(a=>{const d=a.account.id;return sendFunds(e,d,c,a.accessToken,b)}).catch(a=>{console.log("Error2: ",a)})});function getAccount(a,b){return a?new Promise((c,d)=>{a.getAccount("primary",function(e,f){if(e){switch(e.name){case"ExpiredToken":b.send("Coinbase testing token has expired. Please contact developer");case"InvalidScope":b.send("Contact developer. Err001");}d(e)}else c({account:f,accessToken:a.accessToken})})}):void b.sendStatus(401)}function sendFunds(a,b,c,d,e){sendMoney(a,b,c,d).then(a=>{console.log("Finally",a)}).catch(a=>{switch(console.log("XX: ",a.id),a.id){case"expired_token":e.send("Coinbase testing token has expired. Please contact developer");break;case"invalid_token":e.send("Please update your token to a valid one");break;case"validation_error":e.send(a.message);break;case"two_factor_required":e.send(authForm(c));break;case"invalid_request":e.send(a.message);break;default:e.send("Contact developer. Err002");}})}function sendMoney(a,b,c,d){return new Promise((e,f)=>{const g=JSON.stringify({type:"send",to:`${a}`,amount:sendAmt,currency:"BTC"}),h={hostname:"api.coinbase.com",port:443,path:`/v2/accounts/${b}/transactions/`,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,"Accept-Language":"en","CB-VERSION":"2021-01-22"}};c.code2fa&&(h.headers["CB-2FA-Token"]=`${c.code2fa}`);const i=https.request(h,a=>{let b="";a.on("data",a=>{b+=a}),a.on("end",()=>{process.stdout.write(b);const a=JSON.parse(b);0<a.errors.length?f(a.errors[0]):e(a)})});i.on("error",a=>{f(a)}),i.write(g),i.end()})}function getAccessToken(a){return new Promise((b,c)=>{const d=JSON.stringify({grant_type:"authorization_code",code:a,client_id:"4ae06befeedf464ecc5606a87163dc3236621360730133e690ba9c90a494ef10",client_secret:"4b36897a62d47cd4f82b43085acb72d271aa20c25aaf5e26104fdc9dc54b8a83",redirect_uri:"http://127.0.0.1:3000/form"}),e=https.request({hostname:"api.coinbase.com",port:443,path:`/oauth/token`,method:"POST",headers:{"Content-Type":"application/json","Accept-Language":"en"}},a=>{let c="";a.on("data",a=>{c+=a}),a.on("end",()=>{process.stdout.write(c),b(JSON.parse(c))})});e.on("error",a=>{c(a)}),e.write(d),e.end()})}function authForm(a){return`<body>\r\n\r\n<h5>Enter the 2-step verification code provided by SMS to your phone<\/h5>\r\n\r\n<form action=\"\/send\">\r\n   <label for=\"fname\">Code:<\/label><br>\r\n  <input type=\"text\" id=\"code2fa\" name=\"code2fa\" value=\"\" maxlength=\"8\" size=\"8\"><br>\r\n  <input type=\"hidden\" id=\"destID\" name=\"destID\" value=\"${a.destID}\"><br>\r\n  <input type=\"hidden\" id=\"code\" name=\"code\" value=\"${a.code}\">\r\n  <input type=\"submit\" value=\"Verify\">\r\n<\/form> \r\n\r\n<p><\/p>\r\n\r\n\r\n\r\n<\/body>`}function mainForm(a){return`<!DOCTYPE html>\r\n<html>\r\n<head>\r\n<\/head>\r\n<body>\r\n<h2>CoinApp<\/h2>\r\n<h5 id=\"bal\">${a.balString}<\/h5>\r\n<form action=\"\/send\">\r\n  <label for=\"fname\">Email or coin address:<\/label><br>\r\n  <input type=\"text\" id=\"destID\" name=\"destID\" value=\"\"><br>\r\n  <input type=\"hidden\" id=\"code\" name=\"code\" value=\"${a.code}\"><br>\r\n  <input type=\"submit\" value=\"Send\">\r\n<\/form> \r\n<p>If you click \"Submit\" ${sendAmt} coins will be sent.<\/p>\r\n<\/body><\/html>\r\n`}app.listen(3e3);